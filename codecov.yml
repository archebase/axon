# =============================================================================
# Codecov Configuration for Axon
# =============================================================================
# Configures coverage reporting behavior and file exclusions.
# See: https://docs.codecov.com/docs/codecov-yaml
#
# Coverage Strategy:
#   - Each workflow uploads coverage directly with flags (for tracking/metrics only)
#   - Codecov automatically merges multiple uploads from the same commit
#   - Status checks use default coverage.status.project.default (auto target on merged coverage)
#   - Flags and components are for tracking/metrics in UI, not for CI status checks
#   - Path normalization is done in each workflow before upload
#
# Architecture:
#   - core/ contains common libraries (axon_logging, axon_mcap, axon_uploader)
#   - middlewares/src/axon_recorder uses core/ libraries as dependencies
#   - ROS tests run on 4 distros: ROS1 Noetic, ROS2 Humble/Jazzy/Rolling
#   - ROS tests cover BOTH middlewares/ code AND core/ code (via library usage)
# =============================================================================

coverage:
  status:
    project:
      default:
        target: auto
        threshold: 1%  # Allow 1% coverage drop before failing
    patch:
      default:
        target: auto

# Flag management - flags are used for tracking/metrics only, not status checks
# Codecov automatically merges all coverage from the same commit
# Status checks use default coverage.status (auto target on merged coverage)
flag_management:
  default_rules:
    carryforward: false
  individual_flags:
    # Flags defined here are for tracking/metrics in Codecov UI only
    # No status checks - components handle aggregated coverage status
    - name: cpp-unit
    - name: cpp-integration
    - name: ros-noetic
    - name: ros-humble
    - name: ros-jazzy
    - name: ros-rolling
    - name: e2e-noetic
    - name: e2e-humble
    - name: e2e-jazzy
    - name: e2e-rolling

# Component management - components aggregate coverage across all flags for tracking
# Components are for metrics/tracking only, not status checks
# Status checks use the default coverage.status.project.default (auto target)
component_management:
  default_rules: {}
  individual_components:
    # Components aggregate coverage from all flags automatically
    # Useful for viewing coverage by library/module in Codecov UI
    - component_id: cpp_axon_logging
      name: axon_logging
      paths:
        - core/axon_logging/**
    
    - component_id: cpp_axon_mcap
      name: axon_mcap
      paths:
        - core/axon_mcap/**
    
    - component_id: cpp_axon_uploader
      name: axon_uploader
      paths:
        - core/axon_uploader/**
    
    - component_id: ros_axon_recorder
      name: axon_recorder
      paths:
        - middlewares/src/axon_recorder/**
    
    - component_id: cpp_all
      name: All C++ Libraries
      paths:
        - core/axon_logging/**
        - core/axon_mcap/**
        - core/axon_uploader/**

# Comment configuration for PR feedback
comment:
  layout: "reach,diff,files,flags,components"  # Include components in PR comments
  behavior: default
  require_changes: true
