#!/bin/bash
# Pre-commit hook for Axon
# Runs clang-format and REUSE compliance checks

set -e

echo "===================================="
echo "Axon Pre-commit Checks"
echo "===================================="

# ============================================================================
# 1. clang-format check
# ============================================================================

echo ""
echo "1. Checking C/C++ code formatting..."

# Find clang-format (prefer version 21)
CLANG_FORMAT=""
for cmd in clang-format-21 clang-format; do
    if command -v "$cmd" &> /dev/null; then
        # Verify it's version 21
        VERSION=$($cmd --version | grep -oE 'version [0-9]+' | grep -oE '[0-9]+' | head -1)
        if [ "$VERSION" = "21" ]; then
            CLANG_FORMAT="$cmd"
            break
        fi
    fi
done

if [ -n "$CLANG_FORMAT" ]; then
    echo "  Using: $CLANG_FORMAT ($($CLANG_FORMAT --version | head -1))"

    # Get list of staged C/C++ files (excluding build directories and deps)
    FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(cpp|hpp|cc|hh|h|c)$' | grep -v -E '(^|/)(build|_deps|\.git)(/|$)' || true)

    if [ -n "$FILES" ]; then
        FAILED=0
        while IFS= read -r FILE; do
            # Check the staged content, not the working directory file
            if ! git show ":$FILE" 2>/dev/null | $CLANG_FORMAT --dry-run --Werror --assume-filename="$FILE" &> /dev/null; then
                echo "  ✗ $FILE needs formatting"
                FAILED=1
            fi
        done <<< "$FILES"

        if [ $FAILED -eq 1 ]; then
            echo ""
            echo "  clang-format check failed. Please run:"
            echo "    make format"
            echo "  or format files individually:"
            echo "    $CLANG_FORMAT -i <file>"
            exit 1
        fi

        echo "  ✓ All C/C++ files are properly formatted"
    else
        echo "  ✓ No C/C++ files to check"
    fi
else
    echo "  ✗ clang-format version 21 not found."
    echo ""
    echo "  Please install clang-format 21:"
    echo ""
    echo "  Linux:"
    echo "    wget -qO- https://apt.llvm.org/llvm.sh | sudo bash -s 21"
    echo "    sudo apt install -y clang-format-21"
    echo ""
    echo "  macOS:"
    echo "    brew install llvm@21"
    echo "    echo 'export PATH=\"/opt/homebrew/opt/llvm@21/bin:\$PATH\"' >> ~/.zshrc"
    echo "    source ~/.zshrc"
    exit 1
fi

# ============================================================================
# 2. REUSE license compliance check
# ============================================================================

echo ""
echo "2. Checking REUSE license compliance..."

if command -v reuse &> /dev/null; then
    echo "  Using: $(reuse --version)"

    # Run REUSE lint and capture output
    if ! reuse lint 2>&1; then
        echo ""
        echo "  ✗ REUSE compliance check failed."
        echo ""
        echo "  Some files are missing licensing information."
        echo "  Please run 'reuse lint' to see the full report."
        echo ""
        echo "  To fix common issues:"
        echo "    reuse annotate --year 2026 --license 'MulanPSL-2.0' <file>"
        echo "    reuse addheader --year 2026 --license 'MulanPSL2.0' <file>"
        echo ""
        echo "  Or run 'reuse fix' to automatically fix issues."
        exit 1
    fi

    echo "  ✓ REUSE compliance check passed"
else
    echo "  ⚠ Warning: reuse not found. Skipping license check."
    echo "  Install with: pip install fsfe-reuse"
fi

# ============================================================================
# Summary
# ============================================================================

echo ""
echo "===================================="
echo "✓ All pre-commit checks passed!"
echo "===================================="
exit 0
