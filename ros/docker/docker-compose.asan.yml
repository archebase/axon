# Docker Compose configuration for running ASAN (Address Sanitizer) debug builds
# 
# This configuration helps debug memory issues like double-free, use-after-free,
# buffer overflows, and memory leaks.
#
# Usage:
#   cd ros/docker
#   
#   # Run ASAN debug build for ROS 2 Humble
#   docker-compose -f docker-compose.asan.yml up asan-ros2-humble --build
#   
#   # Interactive shell for manual debugging
#   docker-compose -f docker-compose.asan.yml run --rm asan-ros2-humble /bin/bash
#   
#   # Run with specific test
#   docker-compose -f docker-compose.asan.yml run --rm asan-ros2-humble \
#     /usr/local/bin/run_asan_debug.sh
#
# ASAN Output:
#   When a memory error is detected, ASAN will print a detailed stack trace showing:
#   - The location of the error (file:line)
#   - The allocation stack trace
#   - The deallocation stack trace (for double-free)
#   - Memory state information

services:
  asan-ros2-humble:
    build:
      context: ../..
      dockerfile: ros/docker/Dockerfile.ros2.humble
    container_name: axon_asan_ros2_humble
    volumes:
      - ../..:/workspace/axon
      - asan-cargo-cache-ros2-humble:/root/.cargo/registry
      - asan-cargo-git-cache-ros2-humble:/root/.cargo/git
      # Use separate build volume for ASAN builds (different compiler flags)
      - asan-ros2-humble-build:/workspace/ros_ws
    environment:
      - ROS_DISTRO=humble
      - ROS_VERSION=2
      # Enable Address Sanitizer
      - ENABLE_ASAN=1
      # ASAN runtime options - suppress ROS2 system library false positives
      # new_delete_type_mismatch=0 and alloc_dealloc_mismatch=0 are needed because
      # ROS2 libraries are not built with ASAN
      - ASAN_OPTIONS=detect_leaks=0:halt_on_error=0:new_delete_type_mismatch=0:alloc_dealloc_mismatch=0:detect_stack_use_after_return=1
      # Symbolize stack traces
      - ASAN_SYMBOLIZER_PATH=/usr/bin/llvm-symbolizer
    network_mode: host
    # Use tty for better output formatting
    tty: true
    stdin_open: true
    command: /usr/local/bin/run_asan_debug.sh

  asan-ros2-jazzy:
    build:
      context: ../..
      dockerfile: ros/docker/Dockerfile.ros2.jazzy
    container_name: axon_asan_ros2_jazzy
    volumes:
      - ../..:/workspace/axon
      - asan-cargo-cache-ros2-jazzy:/root/.cargo/registry
      - asan-cargo-git-cache-ros2-jazzy:/root/.cargo/git
      - asan-ros2-jazzy-build:/workspace/ros_ws
    environment:
      - ROS_DISTRO=jazzy
      - ROS_VERSION=2
      - ENABLE_ASAN=1
      # Same ASAN options - suppress ROS2 false positives
      - ASAN_OPTIONS=detect_leaks=0:halt_on_error=0:new_delete_type_mismatch=0:alloc_dealloc_mismatch=0:detect_stack_use_after_return=1
      - ASAN_SYMBOLIZER_PATH=/usr/bin/llvm-symbolizer
    network_mode: host
    tty: true
    stdin_open: true
    command: /usr/local/bin/run_asan_debug.sh

volumes:
  asan-cargo-cache-ros2-humble:
  asan-cargo-git-cache-ros2-humble:
  asan-ros2-humble-build:
  asan-cargo-cache-ros2-jazzy:
  asan-cargo-git-cache-ros2-jazzy:
  asan-ros2-jazzy-build:

