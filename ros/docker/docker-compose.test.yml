version: '3.8'

# Docker Compose configuration for running tests
# Usage: cd ros/docker && docker-compose -f docker-compose.test.yml up --abort-on-container-exit

services:
  test-ros1:
    build:
      context: ../..
      dockerfile: ros/docker/Dockerfile.ros1
    container_name: axon_test_ros1
    volumes:
      - ../..:/workspace/axon
      - ../../c/target:/workspace/axon/c/target
      - cargo-cache-ros1:/root/.cargo/registry
      - cargo-git-cache-ros1:/root/.cargo/git
    environment:
      - ROS_DISTRO=noetic
      - ROS_VERSION=1
    command: /usr/local/bin/run_tests.sh
    network_mode: host

  test-ros2-humble:
    build:
      context: ../..
      dockerfile: ros/docker/Dockerfile.ros2.humble
    container_name: axon_test_ros2_humble
    volumes:
      - ../..:/workspace/axon
      - ../../c/target:/workspace/axon/c/target
      - cargo-cache-ros2-humble:/root/.cargo/registry
      - cargo-git-cache-ros2-humble:/root/.cargo/git
    environment:
      - ROS_DISTRO=humble
      - ROS_VERSION=2
    command: /usr/local/bin/run_tests.sh
    network_mode: host

  test-ros2-jazzy:
    build:
      context: ../..
      dockerfile: ros/docker/Dockerfile.ros2.jazzy
    container_name: axon_test_ros2_jazzy
    volumes:
      - ../..:/workspace/axon
      - ../../c/target:/workspace/axon/c/target
      - cargo-cache-ros2-jazzy:/root/.cargo/registry
      - cargo-git-cache-ros2-jazzy:/root/.cargo/git
    environment:
      - ROS_DISTRO=jazzy
      - ROS_VERSION=2
    command: /usr/local/bin/run_tests.sh
    network_mode: host

  test-ros2-rolling:
    build:
      context: ../..
      dockerfile: ros/docker/Dockerfile.ros2.rolling
    container_name: axon_test_ros2_rolling
    volumes:
      - ../..:/workspace/axon
      - ../../c/target:/workspace/axon/c/target
      - cargo-cache-ros2-rolling:/root/.cargo/registry
      - cargo-git-cache-ros2-rolling:/root/.cargo/git
    environment:
      - ROS_DISTRO=rolling
      - ROS_VERSION=2
    command: /usr/local/bin/run_tests.sh
    network_mode: host

volumes:
  cargo-cache-ros1:
  cargo-git-cache-ros1:
  cargo-cache-ros2-humble:
  cargo-git-cache-ros2-humble:
  cargo-cache-ros2-jazzy:
  cargo-git-cache-ros2-jazzy:
  cargo-cache-ros2-rolling:
  cargo-git-cache-ros2-rolling:
