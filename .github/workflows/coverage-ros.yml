# =============================================================================
# ROS Coverage Workflow for Axon
# =============================================================================
# Runs tests with coverage instrumentation for both ROS 1 and ROS 2.
# Uses ros-industrial/industrial_ci for Docker-based builds.
# Uploads results to Codecov with separate flags for each distribution.
# =============================================================================

name: ROS Coverage

on:
  push:
    branches: [main, master, develop]
    paths:
      - 'ros/**'
      - '.github/workflows/coverage-ros.yml'
  pull_request:
    branches: [main, master, develop]
    paths:
      - 'ros/**'
      - '.github/workflows/coverage-ros.yml'
  workflow_dispatch:  # Allow manual trigger

# Cancel in-progress runs when a new commit is pushed to the same branch
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ===========================================================================
  # ROS 2 Humble Coverage (via industrial_ci)
  # ===========================================================================
  coverage-humble:
    name: ROS 2 Humble Coverage
    runs-on: ubuntu-latest
    env:
      ROS_DISTRO: humble
      ROS_REPO: main
      CCACHE_DIR: /github/home/.ccache

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Create coverage output directory
        run: mkdir -p ${{ github.workspace }}/coverage_output

      - name: Cache ccache
        uses: actions/cache@v4
        with:
          path: ${{ env.CCACHE_DIR }}
          key: ccache-${{ env.ROS_DISTRO }}-${{ env.ROS_REPO }}-${{ github.sha }}
          restore-keys: |
            ccache-${{ env.ROS_DISTRO }}-${{ env.ROS_REPO }}-

      - name: Run industrial_ci
        uses: ros-industrial/industrial_ci@master
        env:
          ROS_DISTRO: ${{ env.ROS_DISTRO }}
          ROS_REPO: ${{ env.ROS_REPO }}
          CCACHE_DIR: ${{ env.CCACHE_DIR }}
          # Same deps as unit-tests.yml plus lcov for coverage
          ADDITIONAL_DEBS: git ccache libboost-dev libboost-system-dev libboost-log-dev libboost-thread-dev libboost-filesystem-dev libyaml-cpp-dev libzstd-dev liblz4-dev libssl-dev pkg-config libgtest-dev libgmock-dev lcov
          CMAKE_ARGS: -DCMAKE_BUILD_TYPE=Debug -DENABLE_COVERAGE=ON -DAXON_ROS2=ON
          PARALLEL_BUILDS: 2
          # Mount coverage output directory (ccache is auto-mounted by industrial_ci)
          DOCKER_RUN_OPTS: -v ${{ github.workspace }}/coverage_output:/coverage_output
          # Collect coverage after tests (same pattern as integration tests)
          AFTER_SCRIPT: |
            echo "=== Collecting coverage data ==="
            
            # Find the workspace
            if [ -d /root/target_ws ]; then
              WS=/root/target_ws
            elif [ -d /root/catkin_ws ]; then
              WS=/root/catkin_ws
            else
              WS=/root/upstream_ws
            fi
            echo "Workspace: $WS"
            cd $WS
            
            # Detect lcov version
            LCOV_VERSION=$(lcov --version 2>&1 | grep -oP 'LCOV version \K[0-9.]+' || echo "1.0")
            LCOV_MAJOR=$(echo "${LCOV_VERSION}" | cut -d. -f1)
            echo "lcov version: ${LCOV_VERSION}"
            
            IGNORE_FLAGS=""
            if [ "${LCOV_MAJOR}" -ge 2 ]; then
              IGNORE_FLAGS="--ignore-errors mismatch,unused"
            fi
            
            # Capture coverage
            lcov --capture \
              --directory build \
              --output-file /coverage_output/coverage_raw.info \
              --rc lcov_branch_coverage=1 \
              ${IGNORE_FLAGS} || true
            
            # Filter coverage
            lcov --remove /coverage_output/coverage_raw.info \
              '/usr/*' \
              '/opt/*' \
              '*/_deps/*' \
              '*/generated/*' \
              '*/googletest/*' \
              '*/gtest/*' \
              '*/mcap-*/*' \
              '*/mcap/include/*' \
              '*/minio-cpp/*' \
              '*/axon_recorder/test/*' \
              '*/axon_logging/test/*' \
              '*/axon_mcap/test/*' \
              '*/axon_uploader/test/*' \
              '*/rosidl_typesupport_cpp/*' \
              '*/rosidl_typesupport_introspection_cpp/*' \
              '*/rosidl_generator_cpp/*' \
              --output-file /coverage_output/coverage.info \
              --rc lcov_branch_coverage=1 \
              ${IGNORE_FLAGS} || cp /coverage_output/coverage_raw.info /coverage_output/coverage.info 2>/dev/null || true
            
            lcov --list /coverage_output/coverage.info || true
            
            # Normalize paths: strip Docker workspace prefix for Codecov
            # This converts /root/target_ws/src/ros/... to ros/...
            echo "=== Normalizing paths for Codecov ==="
            sed -i "s|${WS}/src/||g" /coverage_output/coverage.info || true
            
            # Debug: show sample of normalized paths
            echo "Sample paths in coverage.info:"
            grep "^SF:" /coverage_output/coverage.info | head -5 || true
            
            # Verify file is not empty
            if [ -s /coverage_output/coverage.info ]; then
              echo "Coverage file size: $(wc -c < /coverage_output/coverage.info) bytes"
            else
              echo "WARNING: coverage.info is empty!"
            fi
            
            echo "=== Coverage collection complete ==="

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v5
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ${{ github.workspace }}/coverage_output/coverage.info
          flags: ros2
          name: axon-ros2-humble-coverage
          fail_ci_if_error: false
          verbose: true

      - name: Upload coverage artifact
        uses: actions/upload-artifact@v4
        with:
          name: coverage-ros2-humble
          path: ${{ github.workspace }}/coverage_output/coverage.info
          retention-days: 30

  # ===========================================================================
  # ROS 1 Noetic Coverage (via industrial_ci)
  # ===========================================================================
  coverage-noetic:
    name: ROS 1 Noetic Coverage
    runs-on: ubuntu-latest
    env:
      ROS_DISTRO: noetic
      ROS_REPO: main
      CCACHE_DIR: /github/home/.ccache

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Create coverage output directory
        run: mkdir -p ${{ github.workspace }}/coverage_output

      - name: Cache ccache
        uses: actions/cache@v4
        with:
          path: ${{ env.CCACHE_DIR }}
          key: ccache-${{ env.ROS_DISTRO }}-${{ env.ROS_REPO }}-${{ github.sha }}
          restore-keys: |
            ccache-${{ env.ROS_DISTRO }}-${{ env.ROS_REPO }}-

      - name: Run industrial_ci
        uses: ros-industrial/industrial_ci@master
        env:
          ROS_DISTRO: ${{ env.ROS_DISTRO }}
          ROS_REPO: ${{ env.ROS_REPO }}
          CCACHE_DIR: ${{ env.CCACHE_DIR }}
          # Same deps as unit-tests.yml plus lcov for coverage
          ADDITIONAL_DEBS: git ccache libboost-dev libboost-system-dev libboost-log-dev libboost-thread-dev libboost-filesystem-dev libyaml-cpp-dev libzstd-dev liblz4-dev libssl-dev pkg-config libgtest-dev libgmock-dev lcov
          CMAKE_ARGS: -DCMAKE_BUILD_TYPE=Debug -DENABLE_COVERAGE=ON -DAXON_ROS1=ON
          PARALLEL_BUILDS: 2
          # Mount coverage output directory (ccache is auto-mounted by industrial_ci)
          DOCKER_RUN_OPTS: -v ${{ github.workspace }}/coverage_output:/coverage_output
          # Collect coverage after tests (same pattern as integration tests)
          AFTER_SCRIPT: |
            echo "=== Collecting coverage data ==="
            
            # Find the workspace
            if [ -d /root/target_ws ]; then
              WS=/root/target_ws
            elif [ -d /root/catkin_ws ]; then
              WS=/root/catkin_ws
            else
              WS=/root/upstream_ws
            fi
            echo "Workspace: $WS"
            cd $WS
            
            # Detect lcov version
            LCOV_VERSION=$(lcov --version 2>&1 | grep -oP 'LCOV version \K[0-9.]+' || echo "1.0")
            LCOV_MAJOR=$(echo "${LCOV_VERSION}" | cut -d. -f1)
            echo "lcov version: ${LCOV_VERSION}"
            
            IGNORE_FLAGS=""
            if [ "${LCOV_MAJOR}" -ge 2 ]; then
              IGNORE_FLAGS="--ignore-errors mismatch,unused"
            fi
            
            # Capture coverage
            lcov --capture \
              --directory build \
              --output-file /coverage_output/coverage_raw.info \
              --rc lcov_branch_coverage=1 \
              ${IGNORE_FLAGS} || true
            
            # Filter coverage
            lcov --remove /coverage_output/coverage_raw.info \
              '/usr/*' \
              '/opt/*' \
              '*/_deps/*' \
              '*/generated/*' \
              '*/googletest/*' \
              '*/gtest/*' \
              '*/mcap-*/*' \
              '*/mcap/include/*' \
              '*/minio-cpp/*' \
              '*/axon_recorder/test/*' \
              '*/axon_logging/test/*' \
              '*/axon_mcap/test/*' \
              '*/axon_uploader/test/*' \
              --output-file /coverage_output/coverage.info \
              --rc lcov_branch_coverage=1 \
              ${IGNORE_FLAGS} || cp /coverage_output/coverage_raw.info /coverage_output/coverage.info 2>/dev/null || true
            
            lcov --list /coverage_output/coverage.info || true
            
            # Normalize paths: strip Docker workspace prefix for Codecov
            # This converts /root/catkin_ws/src/ros/... to ros/...
            echo "=== Normalizing paths for Codecov ==="
            sed -i "s|${WS}/src/||g" /coverage_output/coverage.info || true
            
            # Debug: show sample of normalized paths
            echo "Sample paths in coverage.info:"
            grep "^SF:" /coverage_output/coverage.info | head -5 || true
            
            # Verify file is not empty
            if [ -s /coverage_output/coverage.info ]; then
              echo "Coverage file size: $(wc -c < /coverage_output/coverage.info) bytes"
            else
              echo "WARNING: coverage.info is empty!"
            fi
            
            echo "=== Coverage collection complete ==="

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v5
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ${{ github.workspace }}/coverage_output/coverage.info
          flags: ros1
          name: axon-ros1-noetic-coverage
          fail_ci_if_error: false
          verbose: true

      - name: Upload coverage artifact
        uses: actions/upload-artifact@v4
        with:
          name: coverage-ros1-noetic
          path: ${{ github.workspace }}/coverage_output/coverage.info
          retention-days: 30

  # ===========================================================================
  # Generate Combined HTML Report (on main branch only)
  # ===========================================================================
  coverage-report:
    name: Generate HTML Report
    runs-on: ubuntu-latest
    needs: [coverage-humble, coverage-noetic]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download ROS 2 coverage
        uses: actions/download-artifact@v4
        with:
          name: coverage-ros2-humble
          path: coverage-ros2

      - name: Download ROS 1 coverage
        uses: actions/download-artifact@v4
        with:
          name: coverage-ros1-noetic
          path: coverage-ros1

      - name: Install lcov
        run: sudo apt-get update && sudo apt-get install -y lcov

      - name: Merge and generate HTML report
        run: |
          LCOV_VERSION=$(lcov --version 2>&1 | grep -oP 'LCOV version \K[0-9.]+' || echo "1.0")
          LCOV_MAJOR=$(echo "${LCOV_VERSION}" | cut -d. -f1)

          IGNORE_FLAGS=""
          if [ "${LCOV_MAJOR}" -ge 2 ]; then
            IGNORE_FLAGS="--ignore-errors source,unmapped"
          fi

          # Merge coverage from both ROS versions
          lcov \
            -a coverage-ros2/coverage.info \
            -a coverage-ros1/coverage.info \
            -o coverage_merged.info \
            ${IGNORE_FLAGS} 2>/dev/null || \
            cp coverage-ros2/coverage.info coverage_merged.info

          mkdir -p coverage-html
          genhtml coverage_merged.info \
            --output-directory coverage-html \
            --title "Axon ROS Coverage (Humble + Noetic)" \
            --legend \
            --branch-coverage \
            ${IGNORE_FLAGS} || true

      - name: Upload HTML report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-ros-html-report
          path: coverage-html/
          retention-days: 30
