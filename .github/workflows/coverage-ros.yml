# =============================================================================
# ROS Coverage Workflow for Axon
# =============================================================================
# Runs tests with coverage instrumentation for both ROS 1 and ROS 2.
# Uploads results to Codecov with separate flags for each distribution.
# =============================================================================

name: ROS Coverage

on:
  push:
    branches: [main, master, develop]
    paths:
      - 'ros/**'
      - '.github/workflows/coverage-ros.yml'
  pull_request:
    branches: [main, master, develop]
    paths:
      - 'ros/**'
      - '.github/workflows/coverage-ros.yml'
  workflow_dispatch:  # Allow manual trigger

jobs:
  # ===========================================================================
  # ROS 2 Humble Coverage
  # ===========================================================================
  coverage-humble:
    name: ROS 2 Humble Coverage
    runs-on: ubuntu-22.04
    env:
      ROS_DISTRO: humble
      ROS_VERSION: 2
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up ROS 2 Humble
        uses: ros-tooling/setup-ros@v0.7
        with:
          required-ros-distributions: humble

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            cmake \
            pkg-config \
            libgtest-dev \
            libgmock-dev \
            libyaml-cpp-dev \
            liblz4-dev \
            libzstd-dev \
            libre2-dev \
            libturbojpeg0-dev \
            libboost-dev \
            libboost-system-dev \
            libboost-log-dev \
            libboost-thread-dev \
            libboost-filesystem-dev \
            libssl-dev \
            lcov

      - name: Build GTest from source
        run: |
          if [ -d /usr/src/googletest ]; then
            cd /usr/src/googletest
            sudo cmake -B build
            sudo cmake --build build
            sudo cmake --install build
          fi

      - name: Build with coverage
        run: |
          source /opt/ros/humble/setup.bash
          
          colcon build \
            --packages-select axon_recorder \
            --cmake-args \
              -DCMAKE_BUILD_TYPE=Debug \
              -DENABLE_COVERAGE=ON \
              -DAXON_ROS2=ON \
            --base-paths ros
          
          source install/setup.bash

      - name: Run tests
        run: |
          source /opt/ros/humble/setup.bash
          source install/setup.bash
          
          colcon test \
            --packages-select axon_recorder \
            --event-handlers console_direct+ \
            --base-paths ros \
            --return-code-on-test-failure
          
          colcon test-result --verbose || true

      - name: Generate coverage report
        run: |
          LCOV_VERSION=$(lcov --version 2>&1 | grep -oP 'LCOV version \K[0-9.]+' || echo "1.0")
          LCOV_MAJOR=$(echo "${LCOV_VERSION}" | cut -d. -f1)
          
          IGNORE_FLAGS=""
          if [ "${LCOV_MAJOR}" -ge 2 ]; then
            IGNORE_FLAGS="--ignore-errors mismatch,unused"
          fi
          
          lcov --capture \
            --directory build \
            --output-file coverage_raw.info \
            --rc lcov_branch_coverage=1 \
            ${IGNORE_FLAGS}
          
          lcov --remove coverage_raw.info \
            '/usr/*' \
            '/opt/*' \
            '*/_deps/*' \
            '*/generated/*' \
            '*/googletest/*' \
            '*/gtest/*' \
            '*/mcap-*/*' \
            '*/mcap/include/*' \
            '*/minio-cpp/*' \
            '*/axon_recorder/test/*' \
            '*/axon_logging/test/*' \
            '*/axon_mcap/test/*' \
            '*/axon_uploader/test/*' \
            '*/rosidl_typesupport_cpp/*' \
            '*/rosidl_typesupport_introspection_cpp/*' \
            '*/rosidl_generator_cpp/*' \
            --output-file coverage.info \
            --rc lcov_branch_coverage=1 \
            ${IGNORE_FLAGS}
          
          lcov --list coverage.info

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v5
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./coverage.info
          flags: ros2
          name: axon-ros2-humble-coverage
          fail_ci_if_error: false
          verbose: true

      - name: Upload coverage artifact
        uses: actions/upload-artifact@v4
        with:
          name: coverage-ros2-humble
          path: coverage.info
          retention-days: 30

  # ===========================================================================
  # ROS 1 Noetic Coverage
  # ===========================================================================
  coverage-noetic:
    name: ROS 1 Noetic Coverage
    runs-on: ubuntu-20.04
    env:
      ROS_DISTRO: noetic
      ROS_VERSION: 1
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up ROS 1 Noetic
        uses: ros-tooling/setup-ros@v0.7
        with:
          required-ros-distributions: noetic

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            cmake \
            pkg-config \
            libgtest-dev \
            libgmock-dev \
            libyaml-cpp-dev \
            liblz4-dev \
            libzstd-dev \
            libre2-dev \
            libturbojpeg0-dev \
            libboost-dev \
            libboost-system-dev \
            libboost-log-dev \
            libboost-thread-dev \
            libboost-filesystem-dev \
            libssl-dev \
            lcov \
            python3-catkin-tools

      - name: Build GTest from source
        run: |
          if [ -d /usr/src/googletest ]; then
            cd /usr/src/googletest
            sudo cmake -B build
            sudo cmake --build build
            sudo cmake --install build
          fi

      - name: Build with coverage (catkin)
        run: |
          source /opt/ros/noetic/setup.bash
          
          # Create catkin workspace
          mkdir -p catkin_ws/src
          ln -s ${{ github.workspace }}/ros/axon_recorder catkin_ws/src/axon_recorder
          
          cd catkin_ws
          catkin config \
            --cmake-args \
              -DCMAKE_BUILD_TYPE=Debug \
              -DENABLE_COVERAGE=ON \
              -DAXON_ROS1=ON
          
          catkin build axon_recorder

      - name: Run tests
        run: |
          source /opt/ros/noetic/setup.bash
          source catkin_ws/devel/setup.bash
          
          cd catkin_ws
          catkin test axon_recorder --no-deps
          
          catkin_test_results build/axon_recorder || true

      - name: Generate coverage report
        run: |
          LCOV_VERSION=$(lcov --version 2>&1 | grep -oP 'LCOV version \K[0-9.]+' || echo "1.0")
          LCOV_MAJOR=$(echo "${LCOV_VERSION}" | cut -d. -f1)
          
          IGNORE_FLAGS=""
          if [ "${LCOV_MAJOR}" -ge 2 ]; then
            IGNORE_FLAGS="--ignore-errors mismatch,unused"
          fi
          
          lcov --capture \
            --directory catkin_ws/build \
            --output-file coverage_raw.info \
            --rc lcov_branch_coverage=1 \
            ${IGNORE_FLAGS} || true
          
          lcov --remove coverage_raw.info \
            '/usr/*' \
            '/opt/*' \
            '*/_deps/*' \
            '*/generated/*' \
            '*/googletest/*' \
            '*/gtest/*' \
            '*/mcap-*/*' \
            '*/mcap/include/*' \
            '*/minio-cpp/*' \
            '*/axon_recorder/test/*' \
            '*/axon_logging/test/*' \
            '*/axon_mcap/test/*' \
            '*/axon_uploader/test/*' \
            --output-file coverage.info \
            --rc lcov_branch_coverage=1 \
            ${IGNORE_FLAGS} || cp coverage_raw.info coverage.info 2>/dev/null || true
          
          lcov --list coverage.info || true

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v5
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./coverage.info
          flags: ros1
          name: axon-ros1-noetic-coverage
          fail_ci_if_error: false
          verbose: true

      - name: Upload coverage artifact
        uses: actions/upload-artifact@v4
        with:
          name: coverage-ros1-noetic
          path: coverage.info
          retention-days: 30

  # ===========================================================================
  # Generate Combined HTML Report (on main branch only)
  # ===========================================================================
  coverage-report:
    name: Generate HTML Report
    runs-on: ubuntu-22.04
    needs: [coverage-humble, coverage-noetic]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download ROS 2 coverage
        uses: actions/download-artifact@v4
        with:
          name: coverage-ros2-humble
          path: coverage-ros2

      - name: Download ROS 1 coverage
        uses: actions/download-artifact@v4
        with:
          name: coverage-ros1-noetic
          path: coverage-ros1

      - name: Install lcov
        run: sudo apt-get update && sudo apt-get install -y lcov

      - name: Merge and generate HTML report
        run: |
          LCOV_VERSION=$(lcov --version 2>&1 | grep -oP 'LCOV version \K[0-9.]+' || echo "1.0")
          LCOV_MAJOR=$(echo "${LCOV_VERSION}" | cut -d. -f1)
          
          IGNORE_FLAGS=""
          if [ "${LCOV_MAJOR}" -ge 2 ]; then
            IGNORE_FLAGS="--ignore-errors source,unmapped"
          fi
          
          # Merge coverage from both ROS versions
          lcov \
            -a coverage-ros2/coverage.info \
            -a coverage-ros1/coverage.info \
            -o coverage_merged.info \
            ${IGNORE_FLAGS} 2>/dev/null || \
            cp coverage-ros2/coverage.info coverage_merged.info
          
          mkdir -p coverage-html
          genhtml coverage_merged.info \
            --output-directory coverage-html \
            --title "Axon ROS Coverage (Humble + Noetic)" \
            --legend \
            --branch-coverage \
            ${IGNORE_FLAGS} || true

      - name: Upload HTML report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-ros-html-report
          path: coverage-html/
          retention-days: 30

