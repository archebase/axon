# =============================================================================
# ROS Tests Workflow for Axon
# =============================================================================
# Runs all ROS tests (unit + integration) for axon_recorder package.
# Tests on all distros for compatibility, coverage collected for Humble + Noetic.
#
# Coverage is collected from Humble (ROS2) and Noetic (ROS1) and uploaded to
# Codecov with ros1/ros2 flags for merging.
# =============================================================================

name: ROS Tests

on:
  # Called by ci.yml orchestrator
  workflow_call:
  # Allow standalone runs
  workflow_dispatch:

env:
  # Common dependencies shared across jobs (includes ccache for faster rebuilds)
  # Includes lcov for coverage collection
  COMMON_DEBS: git ccache libboost-dev libboost-system-dev libboost-log-dev libboost-thread-dev libboost-filesystem-dev libyaml-cpp-dev libzstd-dev liblz4-dev libssl-dev pkg-config libgtest-dev libgmock-dev lcov

jobs:
  # ==========================================================================
  # ROS Tests - All unit and integration tests
  # Collects coverage from Humble and Noetic, uploads to Codecov
  # ==========================================================================
  ros-tests:
    name: ROS Tests (${{ matrix.ros_distro }})
    runs-on: ubuntu-latest
    timeout-minutes: 30
    strategy:
      fail-fast: false
      matrix:
        include:
          # ROS 1 Noetic - collect coverage
          - ros_distro: noetic
            ros_repo: main
            collect_coverage: true
            coverage_flag: ros1
          # ROS 2 Humble LTS - collect coverage
          - ros_distro: humble
            ros_repo: main
            collect_coverage: true
            coverage_flag: ros2
          # ROS 2 Jazzy - compatibility testing only
          - ros_distro: jazzy
            ros_repo: main
            collect_coverage: false
            coverage_flag: ""
          # ROS 2 Rolling - compatibility testing only
          - ros_distro: rolling
            ros_repo: main
            collect_coverage: false
            coverage_flag: ""

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Create coverage output directory
        if: matrix.collect_coverage
        run: mkdir -p ${{ github.workspace }}/coverage_output

      - name: Run industrial_ci
        uses: ros-industrial/industrial_ci@master
        env:
          ROS_DISTRO: ${{ matrix.ros_distro }}
          ROS_REPO: ${{ matrix.ros_repo }}
          ADDITIONAL_DEBS: ${{ env.COMMON_DEBS }}
          # Enable coverage for Humble and Noetic, Release for others
          CMAKE_ARGS: ${{ matrix.collect_coverage && '-DCMAKE_BUILD_TYPE=Debug -DENABLE_COVERAGE=ON' || '-DCMAKE_BUILD_TYPE=Release' }}
          PARALLEL_BUILDS: 2
          # Run all tests (unit + integration)
          CTEST_ARGS: --output-on-failure
          # Mount coverage output directory for coverage collection
          DOCKER_RUN_OPTS: ${{ matrix.collect_coverage && format('-v {0}/coverage_output:/coverage_output', github.workspace) || '' }}
          # Collect coverage after tests (only for Humble and Noetic)
          AFTER_SCRIPT: |
            if [ "${{ matrix.collect_coverage }}" != "true" ]; then
              echo "Skipping coverage collection for ${{ matrix.ros_distro }}"
              exit 0
            fi
            
            echo "=== Test Results Summary ==="
            # Show test results including skipped tests
            if [ -d /root/target_ws ]; then
              WS=/root/target_ws
            elif [ -d /root/catkin_ws ]; then
              WS=/root/catkin_ws
            else
              WS=/root/upstream_ws
            fi
            
            # Parse test XML files for skip counts
            echo "Checking for skipped tests..."
            find $WS -name "*.xml" -path "*test_results*" -exec grep -l "skipped" {} \; 2>/dev/null | head -5 || true
            
            # Show ctest results if available
            if [ -f $WS/build/axon_recorder/Testing/Temporary/LastTest.log ]; then
              echo "Last test log tail:"
              tail -50 $WS/build/axon_recorder/Testing/Temporary/LastTest.log | grep -E "SKIP|PASS|FAIL|tests from" || true
            fi
            
            echo "=== Collecting test coverage data ==="
            
            # Find the workspace
            if [ -d /root/target_ws ]; then
              WS=/root/target_ws
            elif [ -d /root/catkin_ws ]; then
              WS=/root/catkin_ws
            else
              WS=/root/upstream_ws
            fi
            echo "Workspace: $WS"
            cd $WS
            
            # Detect lcov version
            LCOV_VERSION=$(lcov --version 2>&1 | grep -oP 'LCOV version \K[0-9.]+' || echo "1.0")
            LCOV_MAJOR=$(echo "${LCOV_VERSION}" | cut -d. -f1)
            echo "lcov version: ${LCOV_VERSION}"
            
            IGNORE_FLAGS=""
            if [ "${LCOV_MAJOR}" -ge 2 ]; then
              IGNORE_FLAGS="--ignore-errors mismatch,unused"
            fi
            
            # Capture coverage
            lcov --capture \
              --directory build \
              --output-file /coverage_output/coverage_raw.info \
              --rc lcov_branch_coverage=1 \
              ${IGNORE_FLAGS} || true
            
            # Filter coverage - remove system, deps, test files
            lcov --remove /coverage_output/coverage_raw.info \
              '/usr/*' \
              '/opt/*' \
              '*/_deps/*' \
              '*/generated/*' \
              '*/googletest/*' \
              '*/gtest/*' \
              '*/mcap-*/*' \
              '*/mcap/include/*' \
              '*/minio-cpp/*' \
              '*/axon_recorder/test/*' \
              '*/axon_logging/test/*' \
              '*/axon_mcap/test/*' \
              '*/axon_uploader/test/*' \
              '*/rosidl_typesupport_cpp/*' \
              '*/rosidl_typesupport_introspection_cpp/*' \
              '*/rosidl_generator_cpp/*' \
              --output-file /coverage_output/coverage.info \
              --rc lcov_branch_coverage=1 \
              ${IGNORE_FLAGS} || cp /coverage_output/coverage_raw.info /coverage_output/coverage.info 2>/dev/null || true
            
            lcov --list /coverage_output/coverage.info || true
            
            # Normalize paths: strip Docker workspace prefix for Codecov
            echo "=== Normalizing paths for Codecov ==="
            # Remove workspace src prefix
            sed -i "s|${WS}/src/||g" /coverage_output/coverage.info || true
            # Also remove Axon/ prefix if present (repo is cloned as Axon/)
            sed -i "s|^SF:Axon/|SF:|g" /coverage_output/coverage.info || true
            
            # Debug: show ALL source file paths for debugging coverage discrepancy
            echo "=== All source file paths in coverage.info ==="
            grep "^SF:" /coverage_output/coverage.info | sort || true
            
            # Show coverage for key files
            echo ""
            echo "=== Coverage for key recorder files ==="
            grep -A2 "recorder_node.cpp\|recording_service_impl.cpp\|ros_interface.cpp" /coverage_output/coverage.info | head -20 || true
            
            # Verify file is not empty
            if [ -s /coverage_output/coverage.info ]; then
              echo "Coverage file size: $(wc -c < /coverage_output/coverage.info) bytes"
            else
              echo "WARNING: coverage.info is empty!"
            fi
            
            echo "=== Test coverage collection complete ==="

      - name: Upload coverage artifact
        if: matrix.collect_coverage
        uses: actions/upload-artifact@v4
        with:
          name: coverage-${{ matrix.ros_distro }}
          path: ${{ github.workspace }}/coverage_output/coverage.info
          retention-days: 30

  # ==========================================================================
  # Final status check - ensures all required jobs passed
  # ==========================================================================
  ros-tests-success:
    name: ROS Tests Success
    runs-on: ubuntu-latest
    needs: [ros-tests]
    if: always()
    steps:
      - name: Check all jobs passed
        run: |
          if [ "${{ needs.ros-tests.result }}" != "success" ]; then
            echo "ROS tests failed"
            exit 1
          fi
          echo "All ROS tests passed!"

