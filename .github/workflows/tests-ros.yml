# =============================================================================
# ROS Tests Workflow for Axon
# =============================================================================
# Runs all ROS unit + integration tests for axon_recorder package.
# Uses Docker images from GHCR for consistent builds across environments.
#
# Coverage is collected from ALL distros (Noetic, Humble, Jazzy, Rolling)
# and uploaded as artifacts for merging in ci.yml.
#
# NOTE: E2E tests (service call tests) run separately via e2e-tests.yml
#       on all ROS distributions (Noetic, Humble, Jazzy, Rolling).
# =============================================================================

name: ROS Tests

on:
  # Called by ci.yml orchestrator
  workflow_call:
  # Allow standalone runs
  workflow_dispatch:

# Workflow-level permissions needed for nested docker-build.yml to push images
permissions:
  contents: read
  packages: write

env:
  REGISTRY: ghcr.io

jobs:
  # ==========================================================================
  # Build Docker Images (reusable workflow)
  # ==========================================================================
  build-images:
    name: Build Images
    uses: ./.github/workflows/docker-build.yml
    secrets: inherit

  # ==========================================================================
  # ROS Tests - All unit and integration tests
  # Collects coverage from Humble and Noetic, uploads to Codecov
  # ==========================================================================
  ros-tests:
    name: (${{ matrix.ros_distro }})
    runs-on: ubuntu-latest
    needs: [build-images]
    timeout-minutes: 30
    strategy:
      fail-fast: false
      matrix:
        include:
          # ROS 1 Noetic
          - ros_distro: noetic
            ros_version: "1"
            script: run_integration.sh
          # ROS 2 Humble LTS
          - ros_distro: humble
            ros_version: "2"
            script: run_integration.sh
          # ROS 2 Jazzy
          - ros_distro: jazzy
            ros_version: "2"
            script: run_integration.sh
          # ROS 2 Rolling
          - ros_distro: rolling
            ros_version: "2"
            script: run_integration.sh

    permissions:
      contents: read
      packages: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Determine image tag and owner
        id: image-info
        run: |
          # Convert owner to lowercase (Docker requires lowercase)
          OWNER=$(echo '${{ github.repository_owner }}' | tr '[:upper:]' '[:lower:]')
          echo "owner=${OWNER}" >> $GITHUB_OUTPUT
          
          # Use PR tag for pull requests, sha tag otherwise
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            TAG="pr-${{ github.event.pull_request.number }}"
          else
            TAG="sha-$(echo ${{ github.sha }} | cut -c1-7)"
          fi
          echo "tag=${TAG}" >> $GITHUB_OUTPUT
          echo "Using image: ${OWNER}/axon-test-${{ matrix.ros_distro }}:${TAG}"

      - name: Pull Docker image
        run: |
          IMAGE="${{ env.REGISTRY }}/${{ steps.image-info.outputs.owner }}/axon-test-${{ matrix.ros_distro }}:${{ steps.image-info.outputs.tag }}"
          echo "Pulling image: ${IMAGE}"
          docker pull "${IMAGE}"
          # Tag as latest for easier reference
          docker tag "${IMAGE}" "axon-test-${{ matrix.ros_distro }}:latest"

      - name: Create coverage output directory
        run: mkdir -p ${{ github.workspace }}/coverage_output

      - name: Run tests
        run: |
          # Run scripts from mounted volume to ensure latest version is used
          docker run --rm \
            -v ${{ github.workspace }}:/workspace/axon \
            -v ${{ github.workspace }}/coverage_output:/coverage_output \
            -e ROS_DISTRO=${{ matrix.ros_distro }} \
            -e ROS_VERSION=${{ matrix.ros_version }} \
            --network host \
            axon-test-${{ matrix.ros_distro }}:latest \
            /workspace/axon/ros/docker/scripts/${{ matrix.script }} --coverage --coverage-output /coverage_output

      - name: Debug coverage output
        run: |
          echo "=== Coverage output files ==="
          ls -la ${{ github.workspace }}/coverage_output/ || echo "No coverage output directory"
          
          if [ -f "${{ github.workspace }}/coverage_output/coverage.info" ]; then
            echo ""
            echo "=== Coverage file size ==="
            wc -l < ${{ github.workspace }}/coverage_output/coverage.info
            
            echo ""
            echo "=== Source file paths (before normalization) ==="
            grep "^SF:" ${{ github.workspace }}/coverage_output/coverage.info | sort | head -20 || echo "No SF entries"
          fi

      - name: Normalize coverage paths
        run: |
          if [ -f "${{ github.workspace }}/coverage_output/coverage.info" ]; then
            chmod +x ${{ github.workspace }}/.github/scripts/normalize_coverage_paths.sh
            ${{ github.workspace }}/.github/scripts/normalize_coverage_paths.sh ${{ github.workspace }}/coverage_output/coverage.info
            echo "Sample paths after normalization:"
            grep "^SF:" ${{ github.workspace }}/coverage_output/coverage.info | sort | head -10 || echo "No SF entries"
          fi

      - name: Upload coverage to Codecov with flag
        uses: codecov/codecov-action@v5
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ${{ github.workspace }}/coverage_output/coverage.info
          flags: ros-${{ matrix.ros_distro }}
          name: ros-${{ matrix.ros_distro }}
          fail_ci_if_error: false
          verbose: true
          disable_search: true
          disable_file_fixes: true
          override_commit: ${{ github.event.pull_request.head.sha || github.sha }}
          override_branch: ${{ github.head_ref || github.ref_name }}
          override_build: ${{ github.run_id }}
          override_pr: ${{ github.event.pull_request.number }}

      - name: Upload coverage artifact
        uses: actions/upload-artifact@v4
        with:
          name: coverage-${{ matrix.ros_distro }}
          path: ${{ github.workspace }}/coverage_output/coverage.info
          retention-days: 30

  # ==========================================================================
  # Final status check - ensures all required jobs passed
  # ==========================================================================
  ros-tests-success:
    name: ROS Tests Success
    runs-on: ubuntu-latest
    needs: [ros-tests]
    if: always()
    steps:
      - name: Check all jobs passed
        run: |
          if [ "${{ needs.ros-tests.result }}" != "success" ]; then
            echo "ROS tests failed"
            exit 1
          fi
          echo "All ROS tests passed!"
