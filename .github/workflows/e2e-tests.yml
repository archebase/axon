# =============================================================================
# E2E Tests Workflow for Axon
# =============================================================================
# Runs end-to-end tests that start axon_recorder_node and make actual ROS
# service calls. Uses Docker images from GHCR for consistent builds.
# Collects coverage data to maximize overall test coverage.
# Runs on all ROS distributions (Noetic, Humble, Jazzy, Rolling).
#
# NOTE: Docker images are built by ci.yml's build-images job before this workflow
#       runs. This workflow only pulls and uses the pre-built images.
# =============================================================================

name: ROS E2E Tests

on:
  # Called by ci.yml orchestrator only
  workflow_call:

# Workflow-level permissions for pulling images from GHCR
permissions:
  contents: read
  packages: write 

env:
  REGISTRY: ghcr.io

jobs:
  # ==========================================================================
  # E2E Tests - End-to-end ROS service tests
  # Starts axon_recorder_node and runs actual ROS service calls
  # Runs on all ROS distributions (Noetic, Humble, Jazzy, Rolling)
  # Collects coverage to capture code paths exercised by E2E scenarios
  # Note: Docker images are expected to be pre-built by ci.yml's build-images job
  # ==========================================================================
  ros-e2e-tests:
    name: (${{ matrix.ros_distro }})
    runs-on: blacksmith-4vcpu-ubuntu-2404
    timeout-minutes: 45
    strategy:
      fail-fast: false
      matrix:
        include:
          # ROS 1 Noetic - collect coverage
          - ros_distro: noetic
            ros_version: "1"
          # ROS 2 Humble LTS - collect coverage
          - ros_distro: humble
            ros_version: "2"
          # ROS 2 Jazzy - collect coverage
          - ros_distro: jazzy
            ros_version: "2"
          # ROS 2 Rolling - collect coverage
          - ros_distro: rolling
            ros_version: "2"

    permissions:
      contents: read
      packages: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Determine image tag and owner
        id: image-info
        run: |
          # Convert owner to lowercase (Docker requires lowercase)
          OWNER=$(echo '${{ github.repository_owner }}' | tr '[:upper:]' '[:lower:]')
          echo "owner=${OWNER}" >> $GITHUB_OUTPUT
          
          # Use PR tag for pull requests, sha tag otherwise
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            TAG="pr-${{ github.event.pull_request.number }}"
          else
            TAG="sha-$(echo ${{ github.sha }} | cut -c1-7)"
          fi
          echo "tag=${TAG}" >> $GITHUB_OUTPUT
          echo "Using image: ${OWNER}/axon-test-${{ matrix.ros_distro }}:${TAG}"

      - name: Pull Docker image
        run: |
          IMAGE="${{ env.REGISTRY }}/${{ steps.image-info.outputs.owner }}/axon-test-${{ matrix.ros_distro }}:${{ steps.image-info.outputs.tag }}"
          echo "Pulling image: ${IMAGE}"
          docker pull "${IMAGE}"
          # Tag as latest for easier reference
          docker tag "${IMAGE}" "axon-test-${{ matrix.ros_distro }}:latest"

      - name: Create coverage output directory
        run: mkdir -p ${{ github.workspace }}/coverage_output

      - name: Run E2E tests with coverage
        run: |
          # Run scripts from mounted volume to ensure latest version is used
          docker run --rm \
            -v ${{ github.workspace }}:/workspace/axon \
            -v ${{ github.workspace }}/coverage_output:/coverage_output \
            -e ROS_DISTRO=${{ matrix.ros_distro }} \
            -e ROS_VERSION=${{ matrix.ros_version }} \
            -e COVERAGE_OUTPUT=/coverage_output \
            --network host \
            axon-test-${{ matrix.ros_distro }}:latest \
            /workspace/axon/docker/scripts/run_e2e_tests.sh --coverage --coverage-output /coverage_output

      - name: Debug coverage output
        run: |
          echo "=== Coverage output files ==="
          ls -la ${{ github.workspace }}/coverage_output/ || echo "No coverage output directory"
          
          if [ -f "${{ github.workspace }}/coverage_output/coverage.info" ]; then
            echo ""
            echo "=== Coverage file size ==="
            wc -l < ${{ github.workspace }}/coverage_output/coverage.info
            
            echo ""
            echo "=== Source file paths (before normalization) ==="
            grep "^SF:" ${{ github.workspace }}/coverage_output/coverage.info | sort | head -20 || echo "No SF entries"
          fi

      - name: Normalize coverage paths
        run: |
          if [ -f "${{ github.workspace }}/coverage_output/coverage.info" ]; then
            chmod +x ${{ github.workspace }}/.github/scripts/normalize_coverage_paths.sh
            ${{ github.workspace }}/.github/scripts/normalize_coverage_paths.sh ${{ github.workspace }}/coverage_output/coverage.info
            echo "Sample paths after normalization:"
            grep "^SF:" ${{ github.workspace }}/coverage_output/coverage.info | sort | head -10 || echo "No SF entries"
          fi

      - name: Upload coverage to Codecov with flag
        uses: codecov/codecov-action@v5
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ${{ github.workspace }}/coverage_output/coverage.info
          flags: e2e-${{ matrix.ros_distro }}
          name: e2e-${{ matrix.ros_distro }}
          fail_ci_if_error: false
          verbose: true
          disable_search: true
          disable_file_fixes: true
          override_commit: ${{ github.event.pull_request.head.sha || github.sha }}
          override_branch: ${{ github.head_ref || github.ref_name }}
          override_build: ${{ github.run_id }}
          override_pr: ${{ github.event.pull_request.number }}

      - name: Upload coverage artifact
        uses: actions/upload-artifact@v4
        with:
          name: coverage-e2e-${{ matrix.ros_distro }}
          path: ${{ github.workspace }}/coverage_output/coverage.info
          retention-days: 30

  # ==========================================================================
  # Final status check
  # ==========================================================================
  e2e-tests-success:
    name: E2E Tests Success
    runs-on: blacksmith-4vcpu-ubuntu-2404
    needs: [ros-e2e-tests]
    if: always()
    steps:
      - name: Check all jobs passed
        run: |
          if [ "${{ needs.ros-e2e-tests.result }}" != "success" ]; then
            echo "E2E tests failed"
            exit 1
          fi
          echo "All E2E tests passed!"
