# =============================================================================
# E2E Tests Workflow for Axon
# =============================================================================
# Runs end-to-end tests that start axon_recorder_node and make actual ROS
# service calls. Uses Docker images from GHCR for consistent builds.
# Collects coverage data to maximize overall test coverage.
# Only runs on Humble LTS - unit tests verify API compatibility across distros.
# =============================================================================

name: E2E Tests

on:
  # Called by ci.yml orchestrator
  workflow_call:
  # Allow standalone runs
  workflow_dispatch:

env:
  REGISTRY: ghcr.io

jobs:
  # ==========================================================================
  # E2E Tests - End-to-end ROS service tests
  # Starts axon_recorder_node and runs actual ROS service calls
  # Only runs on Humble LTS - unit tests verify API compatibility across distros
  # Collects coverage to capture code paths exercised by E2E scenarios
  # ==========================================================================
  ros-e2e-tests:
    name: ROS E2E Tests (humble)
    runs-on: ubuntu-latest
    timeout-minutes: 45

    permissions:
      contents: read
      packages: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Determine image tag
        id: image-tag
        run: |
          # Use PR tag for pull requests, sha tag otherwise
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            TAG="pr-${{ github.event.pull_request.number }}"
          else
            TAG="sha-$(echo ${{ github.sha }} | cut -c1-7)"
          fi
          echo "tag=${TAG}" >> $GITHUB_OUTPUT
          echo "Using image tag: ${TAG}"

      - name: Pull Docker image
        run: |
          IMAGE="${{ env.REGISTRY }}/${{ github.repository_owner }}/axon-test-humble:${{ steps.image-tag.outputs.tag }}"
          echo "Pulling image: ${IMAGE}"
          docker pull "${IMAGE}"
          # Tag as latest for easier reference
          docker tag "${IMAGE}" "axon-test-humble:latest"

      - name: Create coverage output directory
        run: mkdir -p ${{ github.workspace }}/coverage_output

      - name: Run E2E tests with coverage
        run: |
          docker run --rm \
            -v ${{ github.workspace }}:/workspace/axon \
            -v ${{ github.workspace }}/coverage_output:/coverage_output \
            -e ROS_DISTRO=humble \
            -e ROS_VERSION=2 \
            -e COVERAGE_OUTPUT=/coverage_output \
            --network host \
            axon-test-humble:latest \
            /usr/local/bin/run_e2e.sh

      - name: Debug coverage output
        run: |
          echo "=== Coverage output files ==="
          ls -la ${{ github.workspace }}/coverage_output/ || echo "No coverage output directory"
          
          if [ -f "${{ github.workspace }}/coverage_output/coverage.info" ]; then
            echo ""
            echo "=== Coverage file size ==="
            wc -l < ${{ github.workspace }}/coverage_output/coverage.info
            
            echo ""
            echo "=== Source file paths ==="
            grep "^SF:" ${{ github.workspace }}/coverage_output/coverage.info | sort | head -20 || echo "No SF entries"
          fi

      - name: Upload coverage artifact
        uses: actions/upload-artifact@v4
        with:
          name: coverage-e2e-humble
          path: ${{ github.workspace }}/coverage_output/coverage.info
          retention-days: 30

  # ==========================================================================
  # Final status check
  # ==========================================================================
  e2e-tests-success:
    name: E2E Tests Success
    runs-on: ubuntu-latest
    needs: [ros-e2e-tests]
    if: always()
    steps:
      - name: Check all jobs passed
        run: |
          if [ "${{ needs.ros-e2e-tests.result }}" != "success" ]; then
            echo "E2E tests failed"
            exit 1
          fi
          echo "All E2E tests passed!"
