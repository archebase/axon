# =============================================================================
# CI Orchestrator Workflow for Axon
# =============================================================================
# Main entry point that orchestrates the full CI pipeline.
#
# Coverage Collection Strategy:
#   - ROS tests (Humble/Noetic) collect coverage → Codecov (ros1/ros2)
#   - C++ unit tests collect coverage → Codecov (cpp)
#   - E2E tests (Humble) collect coverage → Codecov (ros2)
#
# Pipeline Diagram:
#
#   ┌─────────────────────────────────────────────────┐
#   │            Tests (Stage 1 - parallel)           │
#   │  ┌───────────────────┐  ┌───────────────────┐   │
#   │  │ ROS Tests         │  │ C++ Unit Tests    │   │
#   │  │ (unit+integration)│  │ +cov              │   │
#   │  │ +cov (Humble/     │  │                   │   │
#   │  │      Noetic)      │  │                   │   │
#   │  └───────────────────┘  └───────────────────┘   │
#   └─────────────────────┬───────────────────────────┘
#                         │
#                         ▼
#                   ┌───────────┐
#                   │   E2E     │  (E2E tests after unit tests pass)
#                   │   Tests   │
#                   │   +cov    │
#                   └───────────┘
#
# =============================================================================

name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

# Cancel in-progress runs when a new commit is pushed to the same branch
concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ===========================================================================
  # Stage 1: ROS Tests and C++ Tests (run in parallel)
  # ROS tests include both unit and integration tests
  # ===========================================================================
  tests-ros:
    name: ROS Tests
    uses: ./.github/workflows/tests-ros.yml
    secrets: inherit

  unit-tests-cpp:
    name: C++ Unit Tests
    uses: ./.github/workflows/unit-tests-cpp.yml
    secrets: inherit

  # ===========================================================================
  # Stage 2: E2E Tests (after unit tests pass)
  # E2E tests collect coverage and upload to Codecov
  # ===========================================================================
  e2e-tests:
    name: E2E Tests
    needs: [tests-ros, unit-tests-cpp]
    uses: ./.github/workflows/e2e-tests.yml
    secrets: inherit

  # ===========================================================================
  # Final Status Check
  # ===========================================================================
  ci-success:
    name: CI Success
    runs-on: ubuntu-latest
    needs: [tests-ros, unit-tests-cpp, e2e-tests]
    if: always()
    steps:
      - name: Check pipeline status
        run: |
          echo "ROS Tests: ${{ needs.tests-ros.result }}"
          echo "C++ Unit Tests: ${{ needs.unit-tests-cpp.result }}"
          echo "E2E Tests: ${{ needs.e2e-tests.result }}"
          
          if [ "${{ needs.tests-ros.result }}" != "success" ]; then
            echo "❌ ROS tests failed"
            exit 1
          fi
          
          if [ "${{ needs.unit-tests-cpp.result }}" != "success" ]; then
            echo "❌ C++ unit tests failed"
            exit 1
          fi
          
          if [ "${{ needs.e2e-tests.result }}" != "success" ]; then
            echo "❌ E2E tests failed"
            exit 1
          fi
          
          echo "✅ CI pipeline completed successfully!"
