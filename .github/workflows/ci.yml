# =============================================================================
# CI Orchestrator Workflow for Axon
# =============================================================================
# Main entry point that orchestrates the full CI pipeline.
#
# Coverage Collection Strategy:
#   - Each workflow uploads coverage directly with flags (cpp-unit, cpp-integration, ros-tests)
#   - Codecov automatically merges multiple uploads from the same commit
#   - No local merge step needed - simpler and faster
#
# Pipeline Diagram:
#
#   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
#   â”‚            Tests (Stage 1 - parallel)           â”‚
#   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
#   â”‚  â”‚ ROS Tests         â”‚  â”‚ C++ Unit Tests    â”‚   â”‚
#   â”‚  â”‚ (unit+integration)â”‚  â”‚ +cov artifacts    â”‚   â”‚
#   â”‚  â”‚ +cov artifacts    â”‚  â”‚                   â”‚   â”‚
#   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
#   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
#                         â”‚             â”‚
#                         â”‚             â–¼
#                         â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
#                         â”‚     â”‚ C++ Integr.   â”‚  (MinIO tests)
#                         â”‚     â”‚ Tests +cov    â”‚
#                         â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
#                         â”‚             â”‚
#                         â–¼             â–¼
#                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
#                   â”‚       E2E Tests       â”‚  (ROS service tests)
#                   â”‚         +cov          â”‚
#                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
#                               â”‚
#                               â–¼
#                       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
#                       â”‚    Merge      â”‚  (Merge all coverage)
#                       â”‚   Coverage    â”‚
#                       â”‚   â†’ Codecov   â”‚
#                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
#
# =============================================================================

name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

# Cancel in-progress runs when a new commit is pushed to the same branch
concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

# Workflow-level permissions for nested workflows (docker-build.yml needs packages:write)
permissions:
  contents: read
  packages: write

jobs:
  # ===========================================================================
  # Stage 1: ROS Tests and C++ Tests (run in parallel)
  # ROS tests include both unit and integration tests
  # ===========================================================================
  tests-ros:
    name: ROS Tests
    uses: ./.github/workflows/tests-ros.yml
    secrets: inherit

  unit-tests-cpp:
    name: C++ Unit Tests
    uses: ./.github/workflows/unit-tests-cpp.yml
    secrets: inherit

  # ===========================================================================
  # Stage 1.5: C++ Integration Tests (after C++ unit tests pass)
  # Runs EdgeUploader integration tests with MinIO
  # ===========================================================================
  integration-tests-cpp:
    name: C++ Integration Tests
    needs: [unit-tests-cpp]
    uses: ./.github/workflows/integration-tests-cpp.yml
    secrets: inherit

  # ===========================================================================
  # Stage 2: E2E Tests (after all unit/integration tests pass)
  # ===========================================================================
  e2e-tests:
    name: E2E Tests
    needs: [tests-ros, unit-tests-cpp, integration-tests-cpp]
    uses: ./.github/workflows/e2e-tests.yml
    secrets: inherit

  # ===========================================================================
  # Stage 3: Merge All Coverage and Upload to Codecov
  # Combines coverage from ROS tests, C++ tests (unit + integration), and E2E tests
  # ===========================================================================
  # Final Status Check
  # ===========================================================================
  ci-success:
    name: CI Success
    runs-on: ubuntu-latest
    needs: [tests-ros, unit-tests-cpp, integration-tests-cpp, e2e-tests]
    if: always()
    steps:
      - name: Check pipeline status
        run: |
          echo "ROS Tests: ${{ needs.tests-ros.result }}"
          echo "C++ Unit Tests: ${{ needs.unit-tests-cpp.result }}"
          echo "C++ Integration Tests: ${{ needs.integration-tests-cpp.result }}"
          echo "E2E Tests: ${{ needs.e2e-tests.result }}"
          
          if [ "${{ needs.tests-ros.result }}" != "success" ]; then
            echo "âŒ ROS tests failed"
            exit 1
          fi
          
          if [ "${{ needs.unit-tests-cpp.result }}" != "success" ]; then
            echo "âŒ C++ unit tests failed"
            exit 1
          fi
          
          if [ "${{ needs.integration-tests-cpp.result }}" != "success" ]; then
            echo "âŒ C++ integration tests failed"
            exit 1
          fi
          
          if [ "${{ needs.e2e-tests.result }}" != "success" ]; then
            echo "âŒ E2E tests failed"
            exit 1
          fi
          
          echo "âœ… CI pipeline completed successfully!"
          echo ""
          echo "ğŸ“Š Coverage: Individual workflows upload with flags (cpp-unit, cpp-integration, ros-tests)"
          echo "   Codecov automatically merges multiple uploads from the same commit."
