# =============================================================================
# CI Orchestrator Workflow for Axon
# =============================================================================
# Main entry point that orchestrates the full CI pipeline:
#   1. Unit Tests (C++ and ROS)
#   2. Integration Tests (after unit tests pass)
#   3. Coverage Tests (after integration tests pass)
# =============================================================================

name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

# Cancel in-progress runs when a new commit is pushed to the same branch
concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ===========================================================================
  # Stage 1: Unit Tests
  # ===========================================================================
  unit-tests:
    name: Unit Tests
    uses: ./.github/workflows/unit-tests.yml
    secrets: inherit

  # ===========================================================================
  # Stage 2: Integration Tests (after unit tests pass)
  # ===========================================================================
  integration-tests:
    name: Integration Tests
    needs: unit-tests
    uses: ./.github/workflows/integration-tests.yml
    secrets: inherit

  # ===========================================================================
  # Stage 3: Coverage Tests (after integration tests pass)
  # ===========================================================================
  coverage-cpp:
    name: C++ Coverage
    needs: integration-tests
    uses: ./.github/workflows/coverage-cpp.yml
    secrets: inherit

  coverage-ros:
    name: ROS Coverage
    needs: integration-tests
    uses: ./.github/workflows/coverage-ros.yml
    secrets: inherit

  # ===========================================================================
  # Final Status Check
  # ===========================================================================
  ci-success:
    name: CI Success
    runs-on: ubuntu-latest
    needs: [unit-tests, integration-tests, coverage-cpp, coverage-ros]
    if: always()
    steps:
      - name: Check pipeline status
        run: |
          echo "Unit Tests: ${{ needs.unit-tests.result }}"
          echo "Integration Tests: ${{ needs.integration-tests.result }}"
          echo "C++ Coverage: ${{ needs.coverage-cpp.result }}"
          echo "ROS Coverage: ${{ needs.coverage-ros.result }}"
          
          if [ "${{ needs.unit-tests.result }}" != "success" ]; then
            echo "❌ Unit tests failed"
            exit 1
          fi
          
          if [ "${{ needs.integration-tests.result }}" != "success" ]; then
            echo "❌ Integration tests failed"
            exit 1
          fi
          
          # Coverage failures are warnings, not blockers
          if [ "${{ needs.coverage-cpp.result }}" != "success" ]; then
            echo "⚠️ C++ coverage failed (non-blocking)"
          fi
          
          if [ "${{ needs.coverage-ros.result }}" != "success" ]; then
            echo "⚠️ ROS coverage failed (non-blocking)"
          fi
          
          echo "✅ CI pipeline completed successfully!"

