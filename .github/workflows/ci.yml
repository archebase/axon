# =============================================================================
# CI Orchestrator Workflow for Axon
# =============================================================================
# Main entry point that orchestrates the full CI pipeline.
#
# Coverage Collection Strategy:
#   - ROS unit tests (Humble/Noetic) collect coverage → Codecov (ros1/ros2)
#   - C++ unit tests collect coverage → Codecov (cpp)
#   - Integration tests (Humble/Noetic) collect coverage → Codecov (ros1/ros2)
#   - E2E tests (Humble) collect coverage → Codecov (ros2)
#
# Pipeline Diagram:
#
#   ┌─────────────────────────────────────────────────┐
#   │               Unit Tests (Stage 1)              │
#   │  ┌───────────────────┐  ┌───────────────────┐   │
#   │  │ ROS Unit Tests    │  │ C++ Unit Tests    │   │  (parallel)
#   │  │ +cov (Humble/     │  │ +cov              │   │
#   │  │      Noetic)      │  │                   │   │
#   │  └───────────────────┘  └───────────────────┘   │
#   └─────────────────────┬───────────────────────────┘
#                         │
#                ┌────────┴────────┐
#                ▼                 ▼
#          ┌───────────┐     ┌───────────┐
#          │ Integr.   │     │   E2E     │  (parallel, both collect coverage)
#          │  Tests    │     │   Tests   │
#          │  +cov     │     │   +cov    │
#          └───────────┘     └───────────┘
#
# =============================================================================

name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

# Cancel in-progress runs when a new commit is pushed to the same branch
concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ===========================================================================
  # Stage 1: Unit Tests (ROS and C++ run in parallel)
  # ===========================================================================
  unit-tests-ros:
    name: ROS Unit Tests
    uses: ./.github/workflows/unit-tests-ros.yml
    secrets: inherit

  unit-tests-cpp:
    name: C++ Unit Tests
    uses: ./.github/workflows/unit-tests-cpp.yml
    secrets: inherit

  # ===========================================================================
  # Stage 2: Integration Tests + E2E Tests (parallel after unit tests)
  # Both collect coverage data and upload to Codecov
  # ===========================================================================
  integration-tests:
    name: Integration Tests
    needs: [unit-tests-ros, unit-tests-cpp]
    uses: ./.github/workflows/integration-tests.yml
    secrets: inherit

  e2e-tests:
    name: E2E Tests
    needs: [unit-tests-ros, unit-tests-cpp]
    uses: ./.github/workflows/e2e-tests.yml
    secrets: inherit

  # ===========================================================================
  # Final Status Check
  # ===========================================================================
  ci-success:
    name: CI Success
    runs-on: ubuntu-latest
    needs: [unit-tests-ros, unit-tests-cpp, integration-tests, e2e-tests]
    if: always()
    steps:
      - name: Check pipeline status
        run: |
          echo "ROS Unit Tests: ${{ needs.unit-tests-ros.result }}"
          echo "C++ Unit Tests: ${{ needs.unit-tests-cpp.result }}"
          echo "Integration Tests: ${{ needs.integration-tests.result }}"
          echo "E2E Tests: ${{ needs.e2e-tests.result }}"
          
          if [ "${{ needs.unit-tests-ros.result }}" != "success" ]; then
            echo "❌ ROS unit tests failed"
            exit 1
          fi
          
          if [ "${{ needs.unit-tests-cpp.result }}" != "success" ]; then
            echo "❌ C++ unit tests failed"
            exit 1
          fi
          
          if [ "${{ needs.integration-tests.result }}" != "success" ]; then
            echo "❌ Integration tests failed"
            exit 1
          fi
          
          if [ "${{ needs.e2e-tests.result }}" != "success" ]; then
            echo "❌ E2E tests failed"
            exit 1
          fi
          
          echo "✅ CI pipeline completed successfully!"
