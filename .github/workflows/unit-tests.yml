name: Unit Tests

on:
  # Called by ci.yml orchestrator
  workflow_call:
  # Allow standalone runs
  workflow_dispatch:

env:
  # Common dependencies shared across jobs (includes ccache for faster rebuilds)
  COMMON_DEBS: git ccache libboost-dev libboost-system-dev libboost-log-dev libboost-thread-dev libboost-filesystem-dev libyaml-cpp-dev libzstd-dev liblz4-dev libssl-dev pkg-config libgtest-dev libgmock-dev

jobs:
  # ==========================================================================
  # C++ Tests Job - Build and test the C++ MCAP library
  # ==========================================================================
  cpp-tests:
    name: C++ Tests
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Cache apt packages
        uses: awalsh128/cache-apt-pkgs-action@latest
        with:
          packages: build-essential cmake pkg-config ccache libgtest-dev libgmock-dev libzstd-dev liblz4-dev libboost-dev libboost-log-dev libboost-thread-dev libboost-filesystem-dev
          version: 1.0

      - name: Cache ccache
        uses: actions/cache@v4
        with:
          path: ~/.ccache
          # Key includes OS and a hash; restore-keys allows fallback to main branch cache
          key: ccache-cpp-${{ runner.os }}-${{ hashFiles('cpp/**/*.cpp', 'cpp/**/*.hpp') }}
          restore-keys: |
            ccache-cpp-${{ runner.os }}-

      - name: Configure ccache
        run: |
          ccache --set-config=max_size=500M
          ccache --set-config=compression=true
          ccache -z  # Zero stats

      - name: Build C++ MCAP library with tests
        working-directory: cpp/axon_mcap
        run: |
          mkdir -p build
          cd build
          cmake .. -DAXON_MCAP_BUILD_TESTS=ON \
            -DCMAKE_C_COMPILER_LAUNCHER=ccache \
            -DCMAKE_CXX_COMPILER_LAUNCHER=ccache
          cmake --build . --parallel $(nproc)

      - name: Show ccache stats
        run: ccache -s

      - name: Run C++ tests
        working-directory: cpp/axon_mcap/build
        run: ctest --output-on-failure --verbose

  # ==========================================================================
  # ROS Unit Tests - Runs in PARALLEL with cpp-tests
  # ==========================================================================
  ros-unit-tests:
    name: ROS Unit Tests (${{ matrix.ros_distro }})
    runs-on: ubuntu-latest
    timeout-minutes: 15
    strategy:
      fail-fast: false
      matrix:
        include:
          - ros_distro: noetic
            ros_repo: main
          - ros_distro: humble
            ros_repo: main
          - ros_distro: jazzy
            ros_repo: main
          - ros_distro: rolling
            ros_repo: main

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run industrial_ci
        uses: ros-industrial/industrial_ci@master
        env:
          ROS_DISTRO: ${{ matrix.ros_distro }}
          ROS_REPO: ${{ matrix.ros_repo }}
          ADDITIONAL_DEBS: ${{ env.COMMON_DEBS }}
          CMAKE_ARGS: -DCMAKE_BUILD_TYPE=Release
          PARALLEL_BUILDS: 2

  # ==========================================================================
  # Final status check - ensures all required jobs passed
  # ==========================================================================
  unit-tests-success:
    name: Unit Tests Success
    runs-on: ubuntu-latest
    needs: [cpp-tests, ros-unit-tests]
    if: always()
    steps:
      - name: Check all jobs passed
        run: |
          if [ "${{ needs.cpp-tests.result }}" != "success" ] || \
             [ "${{ needs.ros-unit-tests.result }}" != "success" ]; then
            echo "One or more jobs failed"
            exit 1
          fi
          echo "All unit tests passed!"

